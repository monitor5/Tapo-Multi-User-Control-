{% extends "base.html" %}
{% block title %}ê´€ë¦¬ì í˜ì´ì§€ - Tapo Control{% endblock %}

{% block content %}
<style>
  /* ëŒ€ì‹œë³´ë“œì™€ ì¼ê´€ëœ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
  .admin-table {
    width: 100%;
  }
  
  .admin-table th, 
  .admin-table td {
    vertical-align: middle;
    padding: 0.75rem;
  }
  
  /* ì•¡ì…˜ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
  .action-buttons {
    display: flex;
    gap: 4px;
    justify-content: center;
  }
  
  /* ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
  .alert {
    display: none;
    margin-bottom: 1rem;
  }
  
  /* ì¹´ë“œ ìŠ¤íƒ€ì¼ ê°œì„  */
  .admin-card {
    border: none;
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }
  
  .admin-card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 0.5rem 0.5rem 0 0 !important;
    padding: 1rem;
  }
  
  /* í¼ ìŠ¤íƒ€ì¼ */
  .form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
  }
  
  .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
  }
  
  /* ì‚¬ìš©ì ëª©ë¡ ì»¨í…Œì´ë„ˆ */
  .user-list-container {
    max-height: 500px;
    overflow-y: auto;
  }
  
  /* ì—­í•  ë°°ì§€ ìŠ¤íƒ€ì¼ */
  .role-badge-admin {
    background: linear-gradient(135deg, #ff6b6b, #ee5a24);
  }
  
  .role-badge-user {
    background: linear-gradient(135deg, #74b9ff, #0984e3);
  }
</style>

<!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
<nav class="navbar navbar-light bg-light shadow-sm mb-4">
  <span class="navbar-brand ms-3 fw-semibold">
    <i class="bi bi-gear-fill me-2"></i>ê´€ë¦¬ì í˜ì´ì§€
  </span>
  <div class="d-flex gap-2 me-3">
    <a href="/" class="btn btn-primary btn-sm">
      <i class="bi bi-house-fill me-1"></i>ëŒ€ì‹œë³´ë“œ
    </a>
    <a href="/user" class="btn btn-info btn-sm">
      <i class="bi bi-person-fill me-1"></i>í”„ë¡œí•„
    </a>
    <button id="logoutBtn" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-box-arrow-right me-1"></i>ë¡œê·¸ì•„ì›ƒ
    </button>
  </div>
</nav>

<!-- ì•Œë¦¼ ë©”ì‹œì§€ -->
<div id="alertSuccess" class="alert alert-success" role="alert"></div>
<div id="alertError" class="alert alert-danger" role="alert"></div>

<!-- ìƒˆ ì‚¬ìš©ì ìƒì„± ì¹´ë“œ -->
<div class="card admin-card mb-4">
  <div class="card-header admin-card-header">
    <h5 class="mb-0">
      <i class="bi bi-person-plus-fill me-2"></i>ìƒˆ ì‚¬ìš©ì ìƒì„±
    </h5>
  </div>
  <div class="card-body">
    <form id="createUserForm">
      <div class="row">
        <div class="col-md-4">
          <div class="mb-3">
            <label for="newUsername" class="form-label">
              <i class="bi bi-person me-1"></i>ì‚¬ìš©ìëª…
            </label>
            <input type="text" class="form-control" id="newUsername" required>
          </div>
        </div>
        <div class="col-md-4">
          <div class="mb-3">
            <label for="newPassword" class="form-label">
              <i class="bi bi-lock me-1"></i>ë¹„ë°€ë²ˆí˜¸
            </label>
            <input type="password" class="form-control" id="newPassword" required>
          </div>
        </div>
        <div class="col-md-4">
          <div class="mb-3">
            <label for="newRole" class="form-label">
              <i class="bi bi-shield me-1"></i>ê¶Œí•œ
            </label>
            <select class="form-select" id="newRole">
              <option value="user">ì¼ë°˜ ì‚¬ìš©ì</option>
              <option value="admin">ê´€ë¦¬ì</option>
            </select>
          </div>
        </div>
      </div>
      <button type="submit" class="btn btn-success">
        <i class="bi bi-plus-circle me-1"></i>ì‚¬ìš©ì ìƒì„±
      </button>
    </form>
  </div>
</div>

<!-- í”ŒëŸ¬ê·¸ ê¶Œí•œ ê´€ë¦¬ ì¹´ë“œ -->
<div class="card admin-card mb-4">
  <div class="card-header admin-card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">
      <i class="bi bi-plug-fill me-2"></i>í”ŒëŸ¬ê·¸ ê¶Œí•œ ê´€ë¦¬
    </h5>
    <button class="btn btn-light btn-sm" onclick="console.log('ğŸ”„ ê¶Œí•œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨'); loadPermissions();">
      <i class="bi bi-arrow-clockwise me-1"></i>ìƒˆë¡œê³ ì¹¨
    </button>
  </div>
  <div class="card-body">
    <div id="permissionsContainer">
      <!-- ê¶Œí•œ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </div>
  </div>
</div>

<!-- ì‚¬ìš©ì ëª©ë¡ ì¹´ë“œ -->
<div class="card admin-card">
  <div class="card-header admin-card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">
      <i class="bi bi-people-fill me-2"></i>ì‚¬ìš©ì ëª©ë¡
    </h5>
    <button class="btn btn-light btn-sm" onclick="console.log('ğŸ”„ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ í´ë¦­ë¨'); loadUsers();">
      <i class="bi bi-arrow-clockwise me-1"></i>ìƒˆë¡œê³ ì¹¨
    </button>
  </div>
  <div class="card-body">
    <div class="user-list-container">
      <div class="table-responsive">
        <table class="table table-hover align-middle admin-table">
          <thead class="table-light">
            <tr>
              <th style="width:10%">ID</th>
              <th style="width:30%">ì‚¬ìš©ìëª…</th>
              <th style="width:20%" class="text-center">ê¶Œí•œ</th>
              <th style="width:40%" class="text-center">ì‘ì—…</th>
            </tr>
          </thead>
          <tbody id="userList">
            <!-- ì‚¬ìš©ì ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ëª¨ë‹¬ -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h5 class="modal-title">
          <i class="bi bi-key-fill me-2"></i>ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="resetPasswordForm">
          <input type="hidden" id="resetUserId">
          <div class="mb-3">
            <label for="resetUsername" class="form-label">
              <i class="bi bi-person me-1"></i>ì‚¬ìš©ìëª…
            </label>
            <input type="text" class="form-control" id="resetUsername" readonly>
          </div>
          <div class="mb-3">
            <label for="newPasswordReset" class="form-label">
              <i class="bi bi-lock me-1"></i>ìƒˆ ë¹„ë°€ë²ˆí˜¸
            </label>
            <input type="password" class="form-control" id="newPasswordReset" required>
          </div>
          <div class="mb-3">
            <label for="confirmPassword" class="form-label">
              <i class="bi bi-lock-fill me-1"></i>ë¹„ë°€ë²ˆí˜¸ í™•ì¸
            </label>
            <input type="password" class="form-control" id="confirmPassword" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i>ì·¨ì†Œ
        </button>
        <button type="button" class="btn btn-primary" onclick="resetPassword()">
          <i class="bi bi-check-circle me-1"></i>ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ì‚¬ìš©ìë³„ í”ŒëŸ¬ê·¸ ê¶Œí•œ ê´€ë¦¬ ëª¨ë‹¬ -->
<div class="modal fade" id="userPermissionsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h5 class="modal-title">
          <i class="bi bi-plug-fill me-2"></i>í”ŒëŸ¬ê·¸ ê¶Œí•œ ê´€ë¦¬
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <h6 class="mb-2">
            <i class="bi bi-person-circle me-2"></i>ì‚¬ìš©ì: <span id="modalUsername" class="fw-bold text-primary"></span>
          </h6>
          <input type="hidden" id="modalUserId">
        </div>
        
        <div class="mb-3">
          <label class="form-label fw-semibold">
            <i class="bi bi-list-check me-2"></i>ì ‘ê·¼ ê°€ëŠ¥í•œ í”ŒëŸ¬ê·¸ ì„ íƒ
          </label>
          <div id="userPlugsList" class="border rounded p-3 bg-light">
            <!-- í”ŒëŸ¬ê·¸ ì²´í¬ë°•ìŠ¤ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
          </div>
        </div>
        
        <div class="alert alert-info" role="alert">
          <i class="bi bi-info-circle me-2"></i>
          <strong>ì•ˆë‚´:</strong> ì²´í¬ëœ í”ŒëŸ¬ê·¸ë§Œ í•´ë‹¹ ì‚¬ìš©ìê°€ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i>ì·¨ì†Œ
        </button>
        <button type="button" class="btn btn-primary" onclick="saveUserPermissions()">
          <i class="bi bi-check-circle me-1"></i>ê¶Œí•œ ì €ì¥
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
{% endblock %}

{% block scripts %}
<script>
  /* Jinja2ê°€ SSR ì‹œ ìœ ì €ëª…ì„ ì‚½ì… */
  const USERNAME = "{{ username|e }}".trim();
  
  /* ë¬¸ì„œ ë¡œë“œ ì™„ë£Œ í›„ ì‹¤í–‰ ë³´ì¥ */
  document.addEventListener('DOMContentLoaded', function() {
    console.log('ê´€ë¦¬ì í˜ì´ì§€ DOM ì™„ì „íˆ ë¡œë“œë¨');
    
    // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡
    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", function() {
        console.log("ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì¤‘...");
        
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í† í° ì‚­ì œ
        localStorage.removeItem('access_token');
        
        // ëª¨ë“  ì¿ í‚¤ ì‚­ì œ
        document.cookie.split(";").forEach(function(c) {
          document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
        });
        
        console.log("ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ, ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™");
        location.href = "/login";
      });
    }
    
    /* í† í°ì„ ì„œë²„ë¡œ ì „ì†¡í•˜ê¸° ìœ„í•œ ì„¤ì • */
    function setupAuth() {
      console.log('ğŸ” ê´€ë¦¬ì í˜ì´ì§€ ì¸ì¦ ì„¤ì • ì‹œì‘');
      // í† í°ì´ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
      const token = localStorage.getItem('access_token');
      if (!token) {
        console.log('âŒ í† í° ì—†ìŒ, ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™');
        location.href = "/login";
        return false;
      }
      
      console.log('âœ… í† í° ë°œê²¬:', token.substring(0, 10) + '...');
      
      // í† í° ì¿ í‚¤ì—ë„ ì €ì¥ (ë°±ì—”ë“œì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œì— ì‚¬ìš©)
      document.cookie = `access_token=${token}; path=/; max-age=86400; SameSite=Strict`;
      
      console.log('ğŸ” ì¸ì¦ ì„¤ì • ì™„ë£Œ');
      return true;
    }
    
    // ì¸ì¦ ì„¤ì • ì™„ë£Œ
    setupAuth();
  });
</script>
<script src="/static/js/admin.js"></script>
{% endblock %} 