{% extends "base.html" %}
{% block title %}관리자 페이지 - Tapo Control{% endblock %}

{% block content %}
<style>
  /* 대시보드와 일관된 테이블 스타일 */
  .admin-table {
    width: 100%;
  }
  
  .admin-table th, 
  .admin-table td {
    vertical-align: middle;
    padding: 0.75rem;
  }
  
  /* 액션 버튼 컨테이너 */
  .action-buttons {
    display: flex;
    gap: 4px;
    justify-content: center;
  }
  
  /* 알림 스타일 */
  .alert {
    display: none;
    margin-bottom: 1rem;
  }
  
  /* 카드 스타일 개선 */
  .admin-card {
    border: none;
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }
  
  .admin-card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 0.5rem 0.5rem 0 0 !important;
    padding: 1rem;
  }
  
  /* 폼 스타일 */
  .form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
  }
  
  .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
  }
  
  /* 사용자 목록 컨테이너 */
  .user-list-container {
    max-height: 500px;
    overflow-y: auto;
  }
  
  /* 역할 배지 스타일 */
  .role-badge-admin {
    background: linear-gradient(135deg, #ff6b6b, #ee5a24);
  }
  
  .role-badge-user {
    background: linear-gradient(135deg, #74b9ff, #0984e3);
  }
</style>

<!-- 상단 네비게이션 -->
<nav class="navbar navbar-light bg-light shadow-sm mb-4">
  <span class="navbar-brand ms-3 fw-semibold">
    <i class="bi bi-gear-fill me-2"></i>관리자 페이지
  </span>
  <div class="d-flex gap-2 me-3">
    <a href="/" class="btn btn-primary btn-sm">
      <i class="bi bi-house-fill me-1"></i>대시보드
    </a>
    <a href="/user" class="btn btn-info btn-sm">
      <i class="bi bi-person-fill me-1"></i>프로필
    </a>
    <button id="logoutBtn" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-box-arrow-right me-1"></i>로그아웃
    </button>
  </div>
</nav>

<!-- 알림 메시지 -->
<div id="alertSuccess" class="alert alert-success" role="alert"></div>
<div id="alertError" class="alert alert-danger" role="alert"></div>

<!-- 새 사용자 생성 카드 -->
<div class="card admin-card mb-4">
  <div class="card-header admin-card-header">
    <h5 class="mb-0">
      <i class="bi bi-person-plus-fill me-2"></i>새 사용자 생성
    </h5>
  </div>
  <div class="card-body">
    <form id="createUserForm">
      <div class="row">
        <div class="col-md-4">
          <div class="mb-3">
            <label for="newUsername" class="form-label">
              <i class="bi bi-person me-1"></i>사용자명
            </label>
            <input type="text" class="form-control" id="newUsername" required>
          </div>
        </div>
        <div class="col-md-4">
          <div class="mb-3">
            <label for="newPassword" class="form-label">
              <i class="bi bi-lock me-1"></i>비밀번호
            </label>
            <input type="password" class="form-control" id="newPassword" required>
          </div>
        </div>
        <div class="col-md-4">
          <div class="mb-3">
            <label for="newRole" class="form-label">
              <i class="bi bi-shield me-1"></i>권한
            </label>
            <select class="form-select" id="newRole">
              <option value="user">일반 사용자</option>
              <option value="admin">관리자</option>
            </select>
          </div>
        </div>
      </div>
      <button type="submit" class="btn btn-success">
        <i class="bi bi-plus-circle me-1"></i>사용자 생성
      </button>
    </form>
  </div>
</div>

<!-- 플러그 권한 관리 카드 -->
<div class="card admin-card mb-4">
  <div class="card-header admin-card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">
      <i class="bi bi-plug-fill me-2"></i>플러그 권한 관리
    </h5>
    <button class="btn btn-light btn-sm" onclick="console.log('🔄 권한 목록 새로고침'); loadPermissions();">
      <i class="bi bi-arrow-clockwise me-1"></i>새로고침
    </button>
  </div>
  <div class="card-body">
    <div id="permissionsContainer">
      <!-- 권한 목록이 여기에 동적으로 추가됩니다 -->
    </div>
  </div>
</div>

<!-- 사용자 목록 카드 -->
<div class="card admin-card">
  <div class="card-header admin-card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">
      <i class="bi bi-people-fill me-2"></i>사용자 목록
    </h5>
    <button class="btn btn-light btn-sm" onclick="console.log('🔄 새로고침 버튼 클릭됨'); loadUsers();">
      <i class="bi bi-arrow-clockwise me-1"></i>새로고침
    </button>
  </div>
  <div class="card-body">
    <div class="user-list-container">
      <div class="table-responsive">
        <table class="table table-hover align-middle admin-table">
          <thead class="table-light">
            <tr>
              <th style="width:10%">ID</th>
              <th style="width:30%">사용자명</th>
              <th style="width:20%" class="text-center">권한</th>
              <th style="width:40%" class="text-center">작업</th>
            </tr>
          </thead>
          <tbody id="userList">
            <!-- 사용자 목록이 여기에 동적으로 추가됩니다 -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- 비밀번호 재설정 모달 -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h5 class="modal-title">
          <i class="bi bi-key-fill me-2"></i>비밀번호 재설정
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="resetPasswordForm">
          <input type="hidden" id="resetUserId">
          <div class="mb-3">
            <label for="resetUsername" class="form-label">
              <i class="bi bi-person me-1"></i>사용자명
            </label>
            <input type="text" class="form-control" id="resetUsername" readonly>
          </div>
          <div class="mb-3">
            <label for="newPasswordReset" class="form-label">
              <i class="bi bi-lock me-1"></i>새 비밀번호
            </label>
            <input type="password" class="form-control" id="newPasswordReset" required>
          </div>
          <div class="mb-3">
            <label for="confirmPassword" class="form-label">
              <i class="bi bi-lock-fill me-1"></i>비밀번호 확인
            </label>
            <input type="password" class="form-control" id="confirmPassword" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i>취소
        </button>
        <button type="button" class="btn btn-primary" onclick="resetPassword()">
          <i class="bi bi-check-circle me-1"></i>비밀번호 재설정
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 사용자별 플러그 권한 관리 모달 -->
<div class="modal fade" id="userPermissionsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h5 class="modal-title">
          <i class="bi bi-plug-fill me-2"></i>플러그 권한 관리
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <h6 class="mb-2">
            <i class="bi bi-person-circle me-2"></i>사용자: <span id="modalUsername" class="fw-bold text-primary"></span>
          </h6>
          <input type="hidden" id="modalUserId">
        </div>
        
        <div class="mb-3">
          <label class="form-label fw-semibold">
            <i class="bi bi-list-check me-2"></i>접근 가능한 플러그 선택
          </label>
          <div id="userPlugsList" class="border rounded p-3 bg-light">
            <!-- 플러그 체크박스들이 여기에 동적으로 추가됩니다 -->
          </div>
        </div>
        
        <div class="alert alert-info" role="alert">
          <i class="bi bi-info-circle me-2"></i>
          <strong>안내:</strong> 체크된 플러그만 해당 사용자가 제어할 수 있습니다.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i>취소
        </button>
        <button type="button" class="btn btn-primary" onclick="saveUserPermissions()">
          <i class="bi bi-check-circle me-1"></i>권한 저장
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
{% endblock %}

{% block scripts %}
<script>
  /* Jinja2가 SSR 시 유저명을 삽입 */
  const USERNAME = "{{ username|e }}".trim();
  
  /* 문서 로드 완료 후 실행 보장 */
  document.addEventListener('DOMContentLoaded', function() {
    console.log('관리자 페이지 DOM 완전히 로드됨');
    
    // 로그아웃 버튼 이벤트 핸들러 등록
    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", function() {
        console.log("로그아웃 처리 중...");
        
        // 로컬 스토리지 토큰 삭제
        localStorage.removeItem('access_token');
        
        // 모든 쿠키 삭제
        document.cookie.split(";").forEach(function(c) {
          document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
        });
        
        console.log("로그아웃 완료, 로그인 페이지로 이동");
        location.href = "/login";
      });
    }
    
    /* 토큰을 서버로 전송하기 위한 설정 */
    function setupAuth() {
      console.log('🔐 관리자 페이지 인증 설정 시작');
      // 토큰이 없으면 로그인 페이지로 리다이렉트
      const token = localStorage.getItem('access_token');
      if (!token) {
        console.log('❌ 토큰 없음, 로그인 페이지로 이동');
        location.href = "/login";
        return false;
      }
      
      console.log('✅ 토큰 발견:', token.substring(0, 10) + '...');
      
      // 토큰 쿠키에도 저장 (백엔드에서 사용자 정보 추출에 사용)
      document.cookie = `access_token=${token}; path=/; max-age=86400; SameSite=Strict`;
      
      console.log('🔐 인증 설정 완료');
      return true;
    }
    
    // 인증 설정 완료
    setupAuth();
  });
</script>
<script src="/static/js/admin.js"></script>
{% endblock %} 